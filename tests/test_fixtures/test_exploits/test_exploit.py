"""
Exploits test
"""

from unittest import TestCase
from unittest.mock import mock_open, MagicMock, patch

from fixtures.exploits import Exploits
from structs import RiskLevel


class ExploitTest(TestCase):
    """
    Exploit tests
    """
    PORTS = 'TCP:22.24-26,UDP:17'
    CSV_PARSED = [['id', 'app', 'name', 'title', 'description', 'risk_level', 'services', 'ports'], \
                 [1, 'nmap', 'ssl-poodle', 'SSL POODLE information leak', 'Poodle description', 'None', 'ssh,ftp',
                  PORTS]]

    @patch('builtins.open', mock_open(read_data=""))
    @patch('csv.reader', MagicMock(return_value=CSV_PARSED))
    def test_read_exploit(self):
        """
        Test parsing csv file:

        INPUT:
        csv.parser returns CSV_PARSED

        OUTPUT:
        Exploits object
        """
        exploits = Exploits.read()
        exploit = exploits.find(self.CSV_PARSED[1][1], self.CSV_PARSED[1][2])

        self.assertEqual(exploit.id, self.CSV_PARSED[1][0])
        self.assertEqual(exploit.app, self.CSV_PARSED[1][1])
        self.assertEqual(exploit.name, self.CSV_PARSED[1][2])
        self.assertEqual(exploit.title, self.CSV_PARSED[1][3])
        self.assertEqual(exploit.description, self.CSV_PARSED[1][4])
        self.assertEqual(exploit.risk_level, RiskLevel.from_name(self.CSV_PARSED[1][5]))
        self.assertEqual(exploit.services, {'ssh', 'ftp'})
        self.assertDictEqual(exploit.ports, {'TCP': {22, 24, 25, 26}, 'UDP': {17}})


    def test_parse_ports(self):
        ports = Exploits.parse_ports(self.PORTS)
        self.assertDictEqual(ports, {'TCP': {22, 24, 25, 26}, 'UDP': {17}})

