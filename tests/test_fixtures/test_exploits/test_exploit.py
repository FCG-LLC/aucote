"""
Exploits test
"""

from unittest import TestCase
from unittest.mock import mock_open, MagicMock, patch

from fixtures.exploits import Exploit
from fixtures.exploits import Exploits
from structs import RiskLevel, TransportProtocol, Port


class ExploitTest(TestCase):
    """
    Exploit tests
    """
    PORTS = 'TCP:22.24-26,UDP:17'
    CSV_PARSED = [['id', 'app', 'name', 'title', 'description', 'risk_level', 'services', 'ports'], \
                 [1, 'nmap', 'ssl-poodle', 'SSL POODLE information leak', 'Poodle description', 'None', 'ssh,ftp',
                  PORTS]]

    @patch('builtins.open', mock_open(read_data=""))
    @patch('csv.reader', MagicMock(return_value=CSV_PARSED))
    def test_read_exploit(self):
        """
        Test parsing csv file:

        INPUT:
        csv.parser returns CSV_PARSED

        OUTPUT:
        Exploits object
        """
        exploits = Exploits.read()
        exploit = exploits.find(self.CSV_PARSED[1][1], self.CSV_PARSED[1][2])

        self.assertEqual(exploit.id, self.CSV_PARSED[1][0])
        self.assertEqual(exploit.app, self.CSV_PARSED[1][1])
        self.assertEqual(exploit.name, self.CSV_PARSED[1][2])
        self.assertEqual(exploit.title, self.CSV_PARSED[1][3])
        self.assertEqual(exploit.description, self.CSV_PARSED[1][4])
        self.assertEqual(exploit.risk_level, RiskLevel.from_name(self.CSV_PARSED[1][5]))
        self.assertEqual(exploit.services, {'ssh', 'ftp'})
        self.assertDictEqual(exploit.ports, {'TCP': {22, 24, 25, 26}, 'UDP': {17}})


    def test_parse_ports(self):
        ports = Exploits.parse_ports(self.PORTS)
        self.assertDictEqual(ports, {'TCP': {22, 24, 25, 26}, 'UDP': {17}})

    def test_find_exploits_by_port(self):
        exploits = Exploits()
        exploit_1 = Exploit(app='test', services={'ssh'}, ports={'TCP': {22,23}})
        exploit_2 = Exploit(app='test', services={'test', 'ssh'}, ports={'TCP': {22}, 'UDP': {25}})
        exploit_3 = Exploit(app='test2', services={'test'}, ports={'TCP': {23}, 'UDP': {25}})

        exploits.add(exploit_1)
        exploits.add(exploit_2)
        exploits.add(exploit_3)

        port = Port()
        port.transport_protocol = TransportProtocol.TCP
        port.number = 99
        port.service_name = 'ssh'

        found = exploits.find_all(port)
        self.assertEqual(len(found['test']), 2)
        self.assertIn(exploit_1, found['test'])
        self.assertIn(exploit_2, found['test'])

        port.service_name = 'test'
        found = exploits.find_all(port)
        self.assertEqual(len(found['test2']), 1)
        self.assertEqual(len(found['test']), 1)
        self.assertIn(exploit_2, found['test'])
        self.assertIn(exploit_3, found['test2'])

        port.service_name = '_'
        port.number = 22
        found = exploits.find_all(port)
        self.assertEqual(len(found['test']), 2)
        self.assertIn(exploit_1, found['test'])
        self.assertIn(exploit_2, found['test'])

        port.number = 23
        found = exploits.find_all(port)
        self.assertEqual(len(found['test2']), 1)
        self.assertEqual(len(found['test']), 1)
        self.assertIn(exploit_1, found['test'])
        self.assertIn(exploit_3, found['test2'])

        port.number = 25
        port.transport_protocol = TransportProtocol.UDP
        found = exploits.find_all(port)
        self.assertEqual(len(found['test2']), 1)
        self.assertEqual(len(found['test']), 1)
        self.assertIn(exploit_2, found['test'])
        self.assertIn(exploit_3, found['test2'])

        port.service_name = 'ssh'
        found = exploits.find_all(port)
        self.assertEqual(len(found['test2']), 1)
        self.assertEqual(len(found['test']), 2)
        self.assertIn(exploit_1, found['test'])
        self.assertIn(exploit_2, found['test'])
        self.assertIn(exploit_3, found['test2'])
